ARG COMPILER
FROM ornladios/adios2:ci-x86_64-power8-el7-${COMPILER}-base

# Install SpectrumMPI
WORKDIR /tmp
COPY ibm_smpi*.rpm /tmp/
RUN yum install -y ibm_smpi*.rpm && \
    /bin/env IBM_SPECTRUM_MPI_LICENSE_ACCEPT=yes \
      /opt/ibm/spectrum_mpi/lap_ce/bin/accept_spectrum_mpi_license.sh
ENV MPI_ROOT=/opt/ibm/spectrum_mpi \
    MPI_HOME=/opt/ibm/spectrum_mpi \
    PATH=/opt/ibm/spectrum_mpi/bin:${PATH} \
    LD_LIBRARY_PATH=/opt/ibm/spectrum_mpi/lib:${PATH}

# Install HDF5 1.12.0
WORKDIR /opt/hdf5
ARG HDF5_ARGS
RUN curl -L https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.12/hdf5-1.12.0/src/hdf5-1.12.0.tar.bz2 | \
        tar -xvj && \
    mkdir build && \
    cd build && \
    cmake ${HDF5_ARGS} \
        -DCMAKE_INSTALL_PREFIX=/opt/hdf5/1.12.0 \
        -DBUILD_SHARED_LIBS=ON \
        -DBUILD_STATIC_LIBS=OFF \
        -DCMAKE_BUILD_TYPE=Release \
        -DHDF5_BUILD_CPP_LIB=OFF \
        -DHDF5_BUILD_EXAMPLES=OFF \ 
        -DBUILD_TESTING=OFF \
        -DHDF5_BUILD_TOOLS=ON \
        -DHDF5_ENABLE_PARALLEL=ON \
        ../hdf5-1.12.0 && \
    make -j$(grep -c '^processor' /proc/cpuinfo) install && \
    cd .. && \
    rm -rf hdf5-1.12.0 build
ENV PATH=/opt/hdf5/1.12.0/bin:${PATH} \
    LD_LIBRARY_PATH=/opt/hdf5/1.12.0/lib:${LD_LIBRARY_PATH} \
    CMAKE_PREFIX_PATH=/opt/hdf5/1.12.0:${CMAKE_PREFIX_PATH}

# Misc cleanup of unneeded files
RUN rm -rf /tmp/* && \
    yum clean all

WORKDIR /root
